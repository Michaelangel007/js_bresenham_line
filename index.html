<!DOCTYPE html>
<!--
Michaelangel007
Copyleft 2017
http://htmlpreview.github.io/?https://raw.githubusercontent.com/Michaelangel007/js_bresenham_line/master/index.html
https://cdn.rawgit.com/Michaelangel007/js_bresenham_line/master/index.html
-->
<html>
    <head>
<style>
    .up
    {
        position: relative;
        top        : 0px;
        left       : 0px;
        box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.5);
        font-weight: normal;
    }

    .down
    {
        position: relative;
        top: 2px;
        left: 2px;
        box-shadow: none;
        font-weight: bold;
    }
</style>
<script>
"use strict";

/*
References:
* https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm
* https://csustan.csustan.edu/~tom/Lecture-Notes/Graphics/Bresenham-Line/Bresenham-Line.pdf
* https://rosettacode.org/wiki/Bitmap/Bresenham%27s_line_algorithm
* https://www.cs.helsinki.fi/group/goa/mallinnus/lines/bresenh.html

* Mid-Point
* https://www.tutorialspoint.com/computer_graphics/line_generation_algorithm.htm
* https://upload.wikimedia.org/wikipedia/commons/5/5a/Line_1.5x%2B1_--_planes.svg
* https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm#/media/File:Line_1.5x%2B1_--_planes.svg

* https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas
* http://tutorials.jenkov.com/html5-canvas/pixels.html
*/

// Tpes
    var LINE_FLOAT_ROUND = 0;
    var LINE_FLOAT_TRUNC = 1;
    var LINE_FLOAT_HALFE = 2;
    var LINE_FLOAT_ONE_E = 3;
    var LINE_FLOAT_M_2DY = 4;
    var LINE_FLOAT_E_G_0 = 5;
    var LINE_INT_G0      = 6;
    var LINE_INT_GE      = 7;

    var line = LINE_FLOAT_TRUNC;

// Globals
    var canvas, context, image, data,
        w,
        h,
        gCellW,
        gCellH,
        gZoomX = 16,
        gZoomY = 16;

    // Line end points
    var x0, y0,
        x1, y1;

    var Examples =
    [//x0,y0, x1,y1
       10,20, 40,30, // 0
        0, 5, 31, 7, // 1
        0, 8, 31,11, // 2
        0,11, 31,15, // 3
        0,14, 31,22, // 4
        8,15, 32,22  // 5
    ];

// Debug

    // ========================================================================
    function output( text )
    {
        var pre = document.getElementById( 'output' );
        pre.innerHTML = text;
    }

// FramebufferLINE_INT_G0

    // ========================================================================
    function draw()
    {
        context.putImageData( image, 0, 0 );
    }

    // ========================================================================
    function clear()
    {
        context.clearRect( 0, 0, canvas.width, canvas.height );
    }

    // ========================================================================
    function get()
    {
        image = context.getImageData(0,0,w,h);
        data  = image.data;
    }

// Pixel

    /**
     * {Number}           x
     * {Number}           y
     * {Number|Array}     r
     * {Number|Undefined} g
     * {Number|Undefined} b
     * {Number|Undefined} a
     * Note:
     *   a = 0   transparent
     *   a = 255 opaque
     * Example:
     *   putpixel( 1, 2, 255, 0, 0, 255 );
     *   putpixel( 3, 4, [255, 0, 0, 255] );
     */
    // ========================================================================
    function putpixel( x, y, r,g,b,a)
    {
        var i = ((y * image.width) + x) * 4;

        // r is array [r,g,b,a]
        if ((typeof r === 'object') && Array.isArray( r ))
        {
            var t = r;
            r = t[0];
            g = t[1];
            b = t[2];
            a = t[3];
        }
        // else: 'number'

        data[i+0] = r;
        data[i+1] = g;
        data[i+2] = b;
        data[i+3] = a;
    }

    // ========================================================================
    function addpixel( x, y, r,g,b,a)
    {
        var i = ((y * image.width) + x) * 4;

        // r is array [r,g,b,a]
        if ((typeof r === 'object') && Array.isArray( r ))
        {
            var t = r;
            r = t[0];
            g = t[1];
            b = t[2];
            a = t[3];
        }
        // else: 'number'

        data[i+0] += r;
        data[i+1] += g;
        data[i+2] += b;
        data[i+3] += a;
    }

    // ========================================================================
    function subpixel( x, y, r,g,b,a)
    {
        var i = ((y * image.width) + x) * 4;

        // r is array [r,g,b,a]
        if ((typeof r === 'object') && Array.isArray( r ))
        {
            var t = r;
            r = t[0];
            g = t[1];
            b = t[2];
            a = t[3];
        }
        // else: 'number'

        data[i+0] -= r;
        data[i+1] -= g;
        data[i+2] -= b;
        data[i+3] -= a;
    }

    // ========================================================================
    function mulpixel( x, y, r,g,b,a)
    {
        // var v = h - y; // put origin at bottom-left instead of top-left
        var i = ((y * image.width) + x) * 4;

        // r is array [r,g,b,a]
        if ((typeof r === 'object') && Array.isArray( r ))
        {
            var t = r;
            r = t[0];
            g = t[1];
            b = t[2];
            a = t[3];
        }
        // else: 'number'

        data[i+0] *= r / 255;
        data[i+1] *= g / 255;
        data[i+2] *= b / 255;
        data[i+3] *= a / 255;
    }

    // ========================================================================
    function zoompixel( x, y, op, color )
    {
        var i, j;
        var u = gZoomX-1;
        var v = gZoomY-1;

        for( j = 0; j < v; j++ )
        {
            for( i = 0 ; i < u; i++ )
            {
                op( x*gZoomX + i +  1, y*gZoomY + j + 1, color ); // +1,+1 for grid border
            }
        }
    }

// Line
    function vline( x, color )
    {
        var y;

        for( y = 0; y < h; y++ )
            putpixel( x, y, color );
    }

    function hline( y, color )
    {
        var x;

        for( x = 0 ; x < w; x++ )
            putpixel( x, y, color );
    }

// Grid

    // example: grid( [192,192,192,255] );
    // ========================================================================
    function grid( color )
    {
        var x,y;

        for( y = 0; y < h; y += gZoomY )
            hline( y, color );

        for( x = 0 ; x < w; x += gZoomX )
            vline( x, color );
    }

    // example: gridMajorMinor( [192,192,192,255], [128,128,255,255], 8 );
    function gridMajorMinor( minorColor, majorColor, majorSpacing )
    {
        var u = 0,
            v = 0,
            x,y;

        for( y = 0; y < h; y += gZoomY, ++v )
            if (v % majorSpacing == 0)
                hline( y, majorColor );
            else
                hline( y, minorColor );

        for( x = 0 ; x < w; x += gZoomX, ++u )
            if (u % majorSpacing == 0)
                vline( x, majorColor );
            else
                vline( x, minorColor );
    }

    function gridClampX( x )
    {
        if (x <       0) x = 0;
        if (x >= gCellW) x = gCellW - 1;
        return x;
    }

    function gridClampY( y )
    {
        if (y <       0) y = 0;
        if (y >= gCellH) y = gCellH - 1;
        return y;
    }

// Utility
    // Inspired from: https://gist.github.com/danprince/05cb72052484355f3adc
    function _addClasses( elem, classnames )
    {
        var userClasses = classnames.split( ' ' );
        if( userClasses.length )
            userClasses.forEach( classname =>
                {
                    var classes = elem.getAttribute( 'class' );
                    if (classes === null)
                    {
                        elem.setAttribute( 'class', classname );
                    }
                    else
                    {
                        var list    = classes.split( ' ' );
                        var offset  = list.indexOf( classname );
                        if (offset < 0)
                        {
                            list.push( classname );
                            elem.setAttribute( 'class', list.join( ' ' ) );
                        }
                    }
                }
            );
    }

    // Inspired from: https://gist.github.com/danprince/05cb72052484355f3adc
    function _removeClasses( elem, classnames )
    {
        var userClasses = classnames.split( ' ' );
        if( userClasses.length )
            userClasses.forEach( classname =>
                {
                    var classes = elem.getAttribute( 'class' );
                    if (classes === null)
                    {
                        list = [];
                    }
                    else
                    {
                        var list    = classes.split( ' ' );
                        var offset  = list.indexOf( classname );
                        if (offset >= 0)
                            list.splice( offset, 1 );
                    }
                    elem.setAttribute( 'class', list.join( ' ' ) );
                }
            );
    }



// ========================================================================
function init()
{
    canvas  = document.getElementById( 'canvas' );
    w = canvas.width;
    h = canvas.height;
    context = canvas.getContext( '2d' );

    image   = context.createImageData( w, h );
    data    = image.data;

    gCellW = (w-1)/gZoomX | 0; // w = 501 - 1 / 10 -> 50
    gCellH = (h-1)/gZoomY | 0; // h = 401 - 1 / 10 -> 40

    //x0 = (gCellW /  5)|0, y0 = (2*gCellH/4)|0;
    //x1 = (gCellW - x0)|0, y1 = (3*gCellH/4)|0;
    //console.info( x0, y0 );
    //console.info( x1, y1 );
}

// ========================================================================
function line0( x0, y0, x1, y1, color )
{
    context.beginPath();
    context.strokeStyle = 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3]/255 + ')'; // "#444444";
    context.lineWidth = gZoomX;
    context.imageSmoothingEnabled = false;

    context.moveTo( x0*gZoomX + gZoomX/2, y0*gZoomY + gZoomY/2 );
    context.lineTo( x1*gZoomX + gZoomX/2, y1*gZoomY + gZoomY/2 );
    context.stroke();
}

// floating-point: round
// ========================================================================
function line1( x0, y0, x1, y1, color )
{
    var x, y = y0|0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var m  = dy / dx;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, Math.round(y), putpixel, color );

        y += m;
    }
}

// floating-point: truncate
// ========================================================================
function line2( x0, y0, x1, y1, color )
{
    var x, y = y0|0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var m  = dy / dx;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y|0, putpixel, color );

        y += m;
    }
}

// floating-point: half e
// ========================================================================
function line3( x0, y0, x1, y1, color )
{
    var x, y = y0|0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var m  = dy / dx;
    var e  = 0;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y, putpixel, color );

        e += m;
        if (e > 0.5)
        {
            y++;
            e -= 1;
        }
    }
}

// floating-point: full e
// ========================================================================
function line4( x0, y0, x1, y1, color )
{
    var x, y = y0|0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var m  = 2 * dy / dx;
    var e  = 0;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y, putpixel, color );

        e += m;
        if (e > 1)
        {
            y++;
            e -= 2;
        }
    }
}

// floating-point: m=2dy, e > dx
// ========================================================================
function line5( x0, y0, x1, y1, color )
{
    var x, y = y0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var m  = 2*dy;
    var e  = 0;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y, putpixel, color );

        e += m;
        if (e > dx)
        {
            y++;
            e -= 2*dx;
        }
    }
}

// floating-point: negdx
// ========================================================================
function line6( x0, y0, x1, y1, color )
{
    var x, y = y0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var m  = 2*dy;
    var e  = -dx;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y, putpixel, color );

        e += m;
        if (e > 0)
        {
            y++;
            e -= 2*dx;
        }
    }
}

// integer: > 0
    var color = [0,255,0,128]; // green
// ========================================================================
function linei( x0, y0, x1, y1, color )
{
    var x, y = y0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var s  = -dx;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y, addpixel, color );

        s += 2*dy;
        if (s > 0)
        {
            s -= 2*dx;
            y++;
        }
    }
}

// integer: >= 0
// ========================================================================
function linej( x0, y0, x1, y1, color )
{
    var x, y = y0;

    var dx = x1 - x0;
    var dy = y1 - y0;
    var s  = -dx;

    for( x = x0; x <= x1; ++x )
    {
        zoompixel( x, y, addpixel, color );

        s += 2*dy;
        if (s >= 0)
        {
            s -= 2*dx;
            y++;
        }
    }
}

// UI ___________________________________________________________________

function onExample( which )
{
    var max = Examples.length / 4;
    if (which <   0) which = 0;
    if (which > max) which = max-1;

    x0 = Examples[ which*4 + 0];
    y0 = Examples[ which*4 + 1];
    x1 = Examples[ which*4 + 2];
    y1 = Examples[ which*4 + 3];

    x0 = gridClampX( x0 );
    x1 = gridClampX( x1 );

    y0 = gridClampY( y0 );
    y1 = gridClampY( y1 );

    update( line );
    uiUpdateButtonStates( which, max, 'buttonEx' );
}

function onLine1()
{
    update( LINE_FLOAT_ROUND );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var m  = dy / dx;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, Math.round(y) );\n"+
"\n"+
"        y += m;\n"+
"    }\n";
    output( text );
}

function onLine2()
{
    update( LINE_FLOAT_TRUNC );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var m  = dy / dx;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y|0 );\n"+
"\n"+
"        y += m;\n"+
"    }\n"
    ;
    output( text );
}

function onLine3()
{
    update( LINE_FLOAT_HALFE );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var m  = dy / dx;\n"+
"    var e  = 0;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y );\n"+
"\n"+
"        e += m;\n"+
"        if (e > 0.5)\n"+
"        {\n"+
"            y++;\n"+
"            e -= 1;\n"+
"        }\n"+
"    }\n";
    output( text );
}

function onLine4()
{
    update( LINE_FLOAT_ONE_E );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var m  = 2 * dy / dx;\n"+
"    var e  = 0;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y );\n"+
"\n"+
"        e += m;\n"+
"        if (e > 1)\n"+
"        {\n"+
"            y++;\n"+
"            e -= 2;\n"+
"        }\n"+
"    }\n";
    output( text );
}

function onLine5()
{
    update( LINE_FLOAT_M_2DY );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var m  = 2*dy;\n"+
"    var e  = 0;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y );\n"+
"\n"+
"        e += m;\n"+
"        if (e > dx)\n"+
"        {\n"+
"            y++;\n"+
"            e -= 2*dx;\n"+
"        }\n"+
"    }\n";
    output( text );
}

function onLine6()
{
    update( LINE_FLOAT_E_G_0 );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var m  = 2*dy;\n"+
"    var e  = -dx;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y );\n"+
"\n"+
"        e += m;\n"+
"        if (e > 0)\n"+
"        {\n"+
"            y++;\n"+
"            e -= 2*dx;\n"+
"        }\n"+
"    }\n";

    output( text );
}

function onLineI()
{
    update( LINE_INT_G0 );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var s  = -dx;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y );\n"+
"\n"+
"        s += 2*dy;\n"+
"        if (s > 0)\n"+
"        {\n"+
"            s -= 2*dx;\n"+
"            y++;\n"+
"        }\n"+
"    }\n"+
"";
    output( text );
}

function onLineJ()
{
    update( LINE_INT_GE );

    var text = "" +
"    var dx = x1 - x0;\n"+
"    var dy = y1 - y0;\n"+
"    var s  = -dx;\n"+
"\n"+
"    for( x = x0; x <= x1; ++x )\n"+
"    {\n"+
"        pixel( x, y );\n"+
"\n"+
"        s += 2*dy;\n"+
"        if (s >= 0)\n"+
"        {\n"+
"            s -= 2*dx;\n"+
"            y++;\n"+
"        }\n"+
"    }\n"+
"";
    output( text );
}

function onLoad()
{
    init();
    onExample(5);
    onLineJ();
}

function uiUpdateButtonStates( selected, total, baseName )
{
    for( var button = 0; button < total; button++ )
    {
        var elem = document.getElementById( baseName + button );
        var css = elem.getAttribute( 'class' );

        if (button == selected)
        {
            _removeClasses( elem, 'up' );
            _addClasses( elem, 'down' ) ;
        }
        else
        {
            _removeClasses( elem, 'down' );
            _addClasses( elem, 'up' ) ;
        }
    }
}

function update( type )
{
    line = type;

    uiUpdateButtonStates( type, LINE_INT_GE+1, 'buttonLine' );

    var black  =  [ 128, 128, 128, -64 ];
    var colors = 
    [
        [ 255,   0,   0, 128 ],
        [ 255, 255,   0, 128 ],
        [   0, 255,   0, 128 ],
        [   0, 255, 255, 128 ],
        [   0,   0, 255, 128 ],
        [ 128,   0, 255, 128 ]
    ];
    var next  = (type + 3) % colors.length;

    clear();
    get();
    //grid( [192,192,192,255] ); draw();
    gridMajorMinor( [192,192,192,255], [128,128,255,255], 8 ); draw();

    line0( x0, y0, x1, y1, [ 128, 128, 128, 128 ] ); get(); //colors[ next ]

    if (type == LINE_FLOAT_TRUNC) { line1( x0, y0, x1, y1, colors[type] ); draw(); } // float: truncate
    if (type == LINE_FLOAT_ROUND) { line2( x0, y0, x1, y1, colors[type] ); draw(); } // float: round
    if (type == LINE_FLOAT_HALFE) { line3( x0, y0, x1, y1, colors[type] ); draw(); } // float: e > 0.5
    if (type == LINE_FLOAT_ONE_E) { line4( x0, y0, x1, y1, colors[type] ); draw(); } // float: e > 1
    if (type == LINE_FLOAT_M_2DY) { line5( x0, y0, x1, y1, colors[type] ); draw(); } // float: e > dx
    if (type == LINE_FLOAT_E_G_0) { line6( x0, y0, x1, y1, colors[type] ); draw(); } // float: e > 0
    if (type == LINE_INT_G0     ) { linei( x0, y0, x1, y1, colors[4]    ); draw(); } // int: >  0
    if (type == LINE_INT_GE     ) { linej( x0, y0, x1, y1, colors[5]    ); draw(); } // int: >= 0

    zoompixel( x0, y0, subpixel, black ); draw();
    zoompixel( x1, y1, subpixel, black ); draw();
}
</script>
    </head>
<body onload="onLoad();">
    <table cellpadding='0'>
        <tr>
        <td valign='top'>
            <canvas id='canvas' width='641' height='481'>
            HTML5 Canvas not supported!
            </canvas>
        </td>
        <td valign='top'>
            <pre id='output'></pre>
        <td>
        </tr>
    </table>
    <table>
        <tr><td>
<button id="buttonLine0" onclick="onLine1()">Float Round        </button>
<button id="buttonLine1" onclick="onLine2()">Float Trunc        </button>
<button id="buttonLine2" onclick="onLine3()">Float e &gt; &half;</button>
<button id="buttonLine3" onclick="onLine4()">Float e &gt; 1     </button>
<button id="buttonLine4" onclick="onLine5()">Float e &gt; dx    </button>
<button id="buttonLine5" onclick="onLine6()">Float e &gt; 0     </button>
<button id="buttonLine6" onclick="onLineI()">Int &gt; 0         </button>
<button id="buttonLine7" onclick="onLineJ()">Int &gt;= 0        </button>
        </td></tr><tr><td>
<button id='buttonEx0' onclick='onExample(0)'>Line 0</button>
<button id='buttonEx1' onclick='onExample(1)'>Line 1</button>
<button id='buttonEx2' onclick='onExample(2)'>Line 2</button>
<button id='buttonEx3' onclick='onExample(3)'>Line 3</button>
<button id='buttonEx4' onclick='onExample(4)'>Line 4</button>
<button id='buttonEx5' onclick='onExample(5)'>Line 5</button>
        </td></tr>
    </table>
<h2>Proof of Bresenham / Mid-Point formula</h1>
<pre>
Another way to derive the line drawing algorithm is incrementally.

Assumptions:

* x0 < x1
* y0 < y1

Line has slope, m = dy/dx, less then equal to 45 degrees -- in the first octant.

  \2|1/
  3\|/0
 ---+---
  4/|\7
  /5|6\

Let's start with a "dumb" line drawing:

function line( x0, y0, x1, y1 )
  y = y0;
  for x = x0 to x1
      putpixel( x, y )

Unfortunately this just draws a horizontal line. :-/
What we want is this:

  y = y0;
  for x = x0 to x1
      putpixel( x, y )
      figure out new y

Sometimes we increment y, sometimes we don't:

  y = y0;
  for x = x0 to x1
      putpixel( x, y )
      if( incrementY )
          y = y + 1

If we use floating-point this becomes easy if we keep track of the error:

function line( x0, y0, x1, y1 )
  dy = y1 - y0;
  dx = x1 - x0;
  y = y0;

  e = 0;
  m = dy/dx; // traditional slope
  for x = x0 to x1
      putpixel( x, y )
      e += m;
      if (e > 0.5)
          e = e - 1
          y = y + 1

We want to get rid of that 0.5. We multiply m by 2:

  dy = y1 - y0;
  dx = x1 - x0;
  y = y0;

  e = 0;
  m = 2*dy/dx;
  for x = x0 to x1
      putpixel( x, y )
      e += m;
      if (e > 1)
          e = e - 2
          y = y + 1

We also want to get rid of that division -- we need to multiply all the terms by dx;
this means all terms involving m need to be updated:

  dy = y1 - y0;
  dx = x1 - x0;
  y = y0;

  e = 0;
  m = 2*dy;
  for x = x0 to x1
      putpixel( x, y )
      e += m;
      if (e > dx)
          e = e - 2*dx
          y = y + 1

We also want to compare the sign instead of 'e > dx' -- we can change that by offsetting the initial term.

  dy = y1 - y0;
  dx = x1 - x0;
  y = y0;

  e = -dx;
  m = 2*dy;
  for x = x0 to x1
      putpixel( x, y )
      e += m;
      if (e > 0)
          e = e - 2*dx
          y = y + 1

QED.
</pre>
</body>
</html>

